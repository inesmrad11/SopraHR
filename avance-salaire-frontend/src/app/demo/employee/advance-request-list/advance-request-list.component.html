<app-breadcrumb [breadcrumbItems]="breadcrumbs"></app-breadcrumb>

<!-- Dashboard moderne avec design harmonisé -->
<div class="light-dashboard">
  <!-- Header avec style identique à hr-requests -->
  <div class="welcome-banner">
    <div class="welcome-banner-overlay"></div>
    <div class="welcome-banner-content">
      <div class="welcome-banner-text">
        <div class="welcome-greeting">Mes demandes d'avance</div>
        <div class="welcome-description">Suivez l'état de vos demandes d'avance de salaire et leur progression.</div>
      </div>
      <div class="welcome-banner-actions">
        <div class="search-container">
          <button class="action-btn search-btn" (click)="toggleSearch()" *ngIf="!showSearch">
            <i antIcon type="search" theme="outline"></i>
          </button>
          <div class="inline-search" *ngIf="showSearch">
            <div class="search-input-wrapper">
              <i antIcon type="search" theme="outline"></i>
              <input 
                type="text" 
                placeholder="Rechercher une demande..." 
                [(ngModel)]="searchTerm"
                (input)="onSearchChange($event)"
                class="inline-search-input"
                autofocus
              >
              <button class="close-inline-search" (click)="closeSearch()">
                <i antIcon type="close" theme="outline"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- États de chargement et erreur -->
  <div *ngIf="loading" class="loading-state">
    <div class="loading-spinner"></div>
    <div class="loading-text">Chargement des demandes...</div>
  </div>
  
  <div *ngIf="apiError" class="error-state">
    <div class="error-icon">⚠️</div>
    <div class="error-message">{{ apiError }}</div>
    <button class="retry-btn" (click)="loadRequests()">Réessayer</button>
  </div>

  <!-- Tableau des demandes -->
  <div class="requests-section">
    <div class="requests-header">
      <h2 class="requests-title">Mes demandes d'avance ({{ filteredRequests.length }})</h2>
      <div class="header-actions">
        <button class="sort-btn" (click)="toggleSortOptions()">
          <i antIcon type="sort-ascending" theme="outline"></i>
          Trier
        </button>
      </div>
    </div>
    
    <div class="requests-table">
      <table class="table">
        <thead>
          <tr>
            <th class="amount-header" (click)="sort('requestedAmount')">
              Montant demandé
              <span class="sort-arrow" [ngClass]="getSortClass('requestedAmount')"></span>
            </th>
            <th class="status-header" (click)="sort('status')">
              Statut
              <span class="sort-arrow" [ngClass]="getSortClass('status')"></span>
            </th>
            <th class="progress-header" (click)="sort('repaymentProgress')">
              Remboursement
              <span class="sort-arrow" [ngClass]="getSortClass('repaymentProgress')"></span>
            </th>
            <th class="date-header" (click)="sort('requestDate')">
              Date de demande
              <span class="sort-arrow" [ngClass]="getSortClass('requestDate')"></span>
            </th>
            <th class="actions-header">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let request of paginatedRequests" class="table-row">
            <td class="amount-cell">{{ formatAmount(request.requestedAmount) }}</td>
            <td class="status-cell">
              <span class="status-badge" [ngClass]="getStatusClass(request.status)">
                {{ getStatusDisplay(request.status) }}
              </span>
            </td>
            <td class="progress-cell">
              <div class="progress-container">
                <div class="progress-bar">
                  <div class="progress-fill" [ngClass]="getProgressClass(request)" [style.width]="(request.repaymentProgress || 0) + '%'"></div>
                </div>
                <span class="progress-text">{{ request.repaymentProgress || 0 }}%</span>
              </div>
            </td>
            <td class="date-cell">{{ formatDate(request.requestDate) }}</td>
            <td class="actions-cell">
              <button class="action-btn view-btn" title="Voir détails" (click)="viewRequestDetails(request)">
                <i antIcon type="eye" theme="outline"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="filteredRequests.length === 0" class="empty-row">
            <td colspan="5" class="empty-cell">
              <div class="empty-state">
                <i antIcon type="file-text" theme="outline"></i>
                <h3>Aucune demande trouvée</h3>
                <p>Aucune demande ne correspond à vos critères de recherche.</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination -->
      <div *ngIf="filteredRequests.length > 0" class="pagination-section">
        <div class="pagination-left">
          <span class="pagination-info">{{ paginationInfo }}</span>
          <div class="items-per-page">
            <label>Afficher:</label>
            <select 
              [(ngModel)]="itemsPerPage" 
              (change)="onItemsPerPageChange()"
              class="items-per-page-select">
              <option *ngFor="let option of itemsPerPageOptions" [value]="option">
                {{ option }} éléments
              </option>
            </select>
          </div>
        </div>
        <div class="pagination-controls">
          <button 
            class="pagination-btn"
            (click)="previousPage()"
            [disabled]="currentPage === 1">
            <i antIcon type="left" theme="outline"></i>
          </button>
          <span class="page-info">{{ currentPage }} / {{ totalPages }}</span>
          <button 
            class="pagination-btn"
            (click)="nextPage()"
            [disabled]="currentPage === totalPages">
            <i antIcon type="right" theme="outline"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>