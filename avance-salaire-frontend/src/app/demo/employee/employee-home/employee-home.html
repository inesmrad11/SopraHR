<app-breadcrumb type="theme1"></app-breadcrumb>
<!-- Dashboard moderne avec design WealthVault et couleurs Sopra HR -->
<div class="light-dashboard">
  <!-- Header identique à hr-statistics -->
  <div class="welcome-banner" [ngStyle]="{'background-image': 'url(' + welcomeImage + ')'}">
    <div class="welcome-banner-overlay"></div>
    <div class="welcome-banner-content">
      <div class="welcome-banner-text">
        <div class="welcome-date">{{ frenchDate }}</div>
        <div class="welcome-greeting">Bonjour, <b>{{ userFullName }}</b></div>
        <div class="welcome-description">Suivez vos avances de salaire et gérez votre santé financière intelligemment.</div>
      </div>
      <div class="welcome-banner-actions">
        <button class="action-btn search-btn" (click)="toggleSearch()">
          <i antIcon type="search" theme="outline"></i>
        </button>
        <button class="action-btn notification-btn" (click)="toggleNotifications()">
          <i antIcon type="bell" theme="outline"></i>
          <span class="notification-badge" *ngIf="unreadNotifications > 0">{{ unreadNotifications }}</span>
        </button>
        <button class="export-btn" (click)="exportData()">
          <i antIcon type="download" theme="outline"></i>
          Exporter
        </button>
      </div>
    </div>
  </div>

  <!-- Barre de recherche -->
  <div class="search-overlay" *ngIf="showSearch" (click)="closeSearch()">
    <div class="search-modal" (click)="$event.stopPropagation()">
      <div class="search-header">
        <h3>Recherche avancée</h3>
        <button class="close-btn" (click)="closeSearch()">
          <i antIcon type="close" theme="outline"></i>
        </button>
      </div>
      <div class="search-content">
        <div class="search-input-group">
          <i antIcon type="search" theme="outline"></i>
          <input 
            type="text" 
            placeholder="Rechercher dans vos demandes..." 
            [(ngModel)]="searchQuery"
            (input)="onSearchInput()"
            class="search-input"
          >
        </div>
        <div class="search-filters">
          <div class="filter-group">
            <label>Statut</label>
            <select [(ngModel)]="searchFilters.status" (change)="applyFilters()">
              <option value="">Tous</option>
              <option value="PENDING">En attente</option>
              <option value="APPROVED">Approuvées</option>
              <option value="REJECTED">Rejetées</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Montant minimum</label>
            <input type="number" [(ngModel)]="searchFilters.minAmount" (input)="applyFilters()" placeholder="0">
          </div>
          <div class="filter-group">
            <label>Montant maximum</label>
            <input type="number" [(ngModel)]="searchFilters.maxAmount" (input)="applyFilters()" placeholder="∞">
          </div>
        </div>
        <div class="search-results" *ngIf="searchResults.length > 0">
          <h4>Résultats ({{ searchResults.length }})</h4>
          <div class="result-item" *ngFor="let result of searchResults" (click)="viewRequestDetails(result)">
            <div class="result-info">
              <div class="result-title">Demande #{{ result.id }}</div>
              <div class="result-details">{{ result.requestedAmount }} TND - {{ result.status }}</div>
            </div>
            <i antIcon type="arrow-right" theme="outline"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal des notifications -->
  <div class="notification-overlay" *ngIf="showNotifications" (click)="closeNotifications()">
    <div class="notification-modal" (click)="$event.stopPropagation()">
      <div class="notification-header">
        <h3>Notifications</h3>
        <button class="close-btn" (click)="closeNotifications()">
          <i antIcon type="close" theme="outline"></i>
        </button>
      </div>
      <div class="notification-content">
        <div class="notification-item" *ngFor="let notification of notifications">
          <div class="notification-icon" [ngClass]="notification.type">
            <i antIcon [type]="getNotificationIcon(notification.type)" theme="outline"></i>
          </div>
          <div class="notification-body">
            <div class="notification-title">{{ notification.title }}</div>
            <div class="notification-message">{{ notification.message }}</div>
            <div class="notification-time">{{ notification.createdAt | date:'short' }}</div>
          </div>
          <button class="mark-read-btn" (click)="markAsRead(notification.id)" *ngIf="!notification.read">
            <i antIcon type="check" theme="outline"></i>
          </button>
        </div>
        <div class="no-notifications" *ngIf="notifications.length === 0">
          <i antIcon type="bell" theme="outline"></i>
          <p>Aucune notification</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Nouveau layout avec 3 sections principales -->
  <div class="dashboard-main-layout">
    <!-- Section gauche - Grande carte avec métriques -->
    <div class="left-section">
      <div class="large-metric-card">
        <div class="metric-card-header">
          <div class="metric-badge">
            <i antIcon type="check-circle" theme="outline"></i>
            Ce mois +{{ dashboardStats.nbAvancesPossibles }}% Avances
          </div>
        </div>
        <div class="metric-card-content">
          <div class="metric-title">
            <i antIcon type="sync" theme="outline"></i>
            <h2 class="metric-greeting">{{ userFullName }}</h2>
          </div>
          <p class="metric-description">Gérez vos avances de salaire et suivez votre progression financière</p>
        </div>
        <div class="metric-card-stats">
          <div class="stat-item">
            <div class="stat-value">{{ dashboardStats.salary | number:'1.0-0' }} TND</div>
            <div class="stat-label">Salaire net</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ dashboardStats.plafond | number:'1.0-0' }} TND</div>
            <div class="stat-label">Plafond autorisé</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section droite - Cartes plus petites -->
    <div class="right-section">
      <!-- Carte 1: Avances en cours -->
      <div class="small-metric-card advances-card">
        <div class="card-header">
          <div class="card-title">
            <i antIcon type="file" theme="outline"></i>
            <h3>Avances en cours</h3>
          </div>
          <div class="card-trend negative">-{{ dashboardStats.totalNonRembourse | number:'1.0-0' }}%</div>
        </div>
        <div class="card-value">{{ dashboardStats.totalNonRembourse | number:'1.0-0' }}</div>
        <div class="card-chart">
          <div class="mini-bar-chart">
            <div class="bar" style="height: 60%"></div>
            <div class="bar" style="height: 80%"></div>
            <div class="bar" style="height: 40%"></div>
            <div class="bar" style="height: 90%"></div>
            <div class="bar" style="height: 70%"></div>
          </div>
        </div>
      </div>

      <!-- Carte 2: Santé financière -->
      <div class="small-metric-card health-card">
        <div class="card-header">
          <div class="card-title">
            <i antIcon type="check-circle" theme="outline"></i>
            <h3>Santé financière</h3>
          </div>
          <div class="card-trend positive">+{{ financialHealthScore }}%</div>
        </div>
        <div class="card-value">{{ financialHealthScore }}/100</div>
        <div class="card-chart">
          <div class="mini-line-chart">
            <svg width="100" height="40" viewBox="0 0 100 40">
              <path d="M0,30 Q25,20 50,25 T100,15" stroke="#10b981" stroke-width="2" fill="none"/>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section des graphiques et calendrier -->
  <div class="charts-calendar-section">
    <!-- Graphiques -->
    <div class="charts-section">
      <!-- Graphique d'évolution des avances -->
      <div class="chart-card evolution-chart">
        <div class="chart-header">
          <div class="chart-title">
            <i antIcon type="rise" theme="outline"></i>
            Évolution des avances
          </div>
          <button class="chart-action" (click)="showChartAnalysis()">Analyse</button>
        </div>
        <div class="chart-content">
          <ng-container *ngIf="monthlyChartSeries && monthlyChartSeries.length">
            <apx-chart
              [series]="monthlyChartSeries"
              [chart]="{ type: 'line', height: 200, background: 'transparent' }"
              [xaxis]="{ categories: monthlyChartCategories, labels: { style: { colors: '#aaa' } } }"
              [colors]="['#8b5cf6']"
              [stroke]="{ curve: 'smooth', width: 3 }"
              [markers]="{ size: 6, shape: 'circle', colors: ['#fff'], strokeColors: '#8b5cf6', strokeWidth: 3 }"
              [dataLabels]="{ enabled: false }"
              [grid]="{ borderColor: '#e9ecef', strokeDashArray: 4 }"
              [theme]="{ mode: 'light' }"
            ></apx-chart>
          </ng-container>
          <ng-container *ngIf="!monthlyChartSeries || !monthlyChartSeries.length">
            <div class="no-data">Aucune donnée disponible</div>
          </ng-container>
        </div>
      </div>

      <!-- Graphique de répartition des statuts -->
      <div class="chart-card status-chart">
        <div class="chart-header">
          <div class="chart-title">
            <i antIcon type="pie-chart" theme="outline"></i>
            Répartition des statuts
          </div>
        </div>
        <div class="chart-content">
          <ng-container *ngIf="statusPieChart && statusPieChart.length">
            <apx-chart
              [series]="[statusPieChart[0]?.y || 0, statusPieChart[1]?.y || 0, statusPieChart[2]?.y || 0]"
              [labels]="['En attente', 'Validées', 'Rejetées']"
              [chart]="{ type: 'pie', height: 200, background: 'transparent' }"
              [colors]="['#f6c23e', '#1cc88a', '#e74a3b']"
              [theme]="{ mode: 'light' }"
            ></apx-chart>
          </ng-container>
          <ng-container *ngIf="!statusPieChart || !statusPieChart.length">
            <div class="no-data">Aucune donnée disponible</div>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- Calendrier -->
    <div class="calendar-section">
      <div class="calendar-card">
        <div class="calendar-header">
          <h3>Calendrier</h3>
          <div class="calendar-nav">
            <button class="nav-btn" (click)="previousMonth()">
              ‹
            </button>
            <span class="current-month">{{ calendarMonth }}</span>
            <button class="nav-btn" (click)="nextMonth()">
              ›
            </button>
          </div>
        </div>
        <div class="calendar-body">
          <div class="calendar-weekdays">
            <div class="weekday">Lun</div>
            <div class="weekday">Mar</div>
            <div class="weekday">Mer</div>
            <div class="weekday">Jeu</div>
            <div class="weekday">Ven</div>
            <div class="weekday">Sam</div>
            <div class="weekday">Dim</div>
          </div>
          <div class="calendar-days">
            <div 
              *ngFor="let day of calendarDays" 
              class="day" 
              [class.other-month]="!day.isCurrentMonth"
              [class.current]="day.isToday"
              [class.has-event]="day.hasEvent"
            >
              {{ day.day }}
            </div>
          </div>
        </div>
        <div class="calendar-events">
          <div class="event-item">
            <div class="event-dot advance"></div>
            <span>Demande avance</span>
          </div>
          <div class="event-item">
            <div class="event-dot payment"></div>
            <span>Remboursement</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tableau des demandes récentes -->
  <div class="alerts-section">
    <div class="alerts-header">
      <h2 class="alerts-title">Mes demandes récentes</h2>
      <button class="filters-btn" (click)="showSmartFilters()">
        <i antIcon type="tool" theme="outline"></i>
        Filtres intelligents
      </button>
    </div>
    <div class="alerts-table">
      <table class="table">
        <thead>
          <tr>
            <th>Montant</th>
            <th>Statut</th>
            <th>Date</th>
            <th>Progression</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (req of filteredRequests; track req) {
            <tr class="table-row">
              <td class="amount-cell">{{ req.requestedAmount }} TND</td>
              <td class="status-cell">
                <span class="status-badge" [ngClass]="{
                  'status-pending': req.status === 'PENDING',
                  'status-approved': req.status === 'APPROVED',
                  'status-rejected': req.status === 'REJECTED'
                }">
                  {{ req.status === 'PENDING' ? 'En attente' : req.status === 'APPROVED' ? 'Approuvée' : 'Rejetée' }}
                </span>
              </td>
              <td class="date-cell">{{ req.requestDate | date:'shortDate' }}</td>
              <td class="progress-cell">
                <div class="progress-bar">
                  <div class="progress-fill" [style.width]="getProgressPercentage(req) + '%'"></div>
                </div>
                <span class="progress-text">{{ getProgressPercentage(req) }}%</span>
              </td>
              <td class="actions-cell">
                <button class="action-btn" title="Voir détails" (click)="viewRequestDetails(req)">
                  <i antIcon type="eye" theme="outline"></i>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- Métriques supplémentaires -->
  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-header">
        <div class="transaction-icon">
          <i antIcon type="warning" theme="outline"></i>
        </div>
        <span>Marge restante</span>
      </div>
      <div class="metric-value">{{ dashboardStats.plafondDisponible | number:'1.0-0' }} TND</div>
      <div class="metric-progress">
        <div class="progress-bar" [style.width]="getMarginPercentage() + '%'"></div>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-header">
        <i antIcon type="clock-circle" theme="outline"></i>
        <span>Progression remboursement</span>
      </div>
      <div class="metric-value">{{ globalRepaymentProgress }}%</div>
      <div class="metric-trend" [ngClass]="globalRepaymentProgress === 100 ? 'positive' : 'negative'">
        {{ globalRepaymentProgress === 100 ? 'Bravo !' : 'En cours' }}
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-header">
        <i antIcon type="alert" theme="outline"></i>
        <span>Santé financière</span>
      </div>
      <div class="metric-value">{{ financialHealthScore }} / 100</div>
      <div class="metric-trend" [ngClass]="financialHealthColor">
        {{ financialHealthLabel }}
      </div>
    </div>
  </div>
</div>
  
<!-- Modal d'analyse des graphiques -->
<div class="analysis-overlay" *ngIf="showAnalysis" (click)="closeAnalysis()">
  <div class="analysis-modal" (click)="$event.stopPropagation()">
    <div class="analysis-header">
      <h3>Analyse détaillée - Évolution des avances</h3>
      <button class="close-btn" (click)="closeAnalysis()">
        <i antIcon type="close" theme="outline"></i>
      </button>
    </div>
    <div class="analysis-content">
      <div class="analysis-stats">
        <div class="stat-card">
          <div class="stat-title">Total des demandes</div>
          <div class="stat-value">{{ totalRequests }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Moyenne mensuelle</div>
          <div class="stat-value">{{ averageMonthlyRequests }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Tendance</div>
          <div class="stat-value" [ngClass]="trendDirection">{{ trendPercentage }}%</div>
        </div>
      </div>
      <div class="analysis-insights">
        <h4>Insights</h4>
        <div class="insight-item" *ngFor="let insight of chartInsights">
          <i antIcon [type]="insight.icon" theme="outline"></i>
          <span>{{ insight.message }}</span>
        </div>
      </div>
      <div class="analysis-actions">
        <button class="action-btn" (click)="exportChartData()">
          <i antIcon type="download" theme="outline"></i>
          Exporter les données
        </button>
        <button class="action-btn" (click)="generateReport()">
          <i antIcon type="file-text" theme="outline"></i>
          Générer un rapport
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal des filtres intelligents -->
<div class="filters-overlay" *ngIf="showFilters" (click)="closeFilters()">
  <div class="filters-modal" (click)="$event.stopPropagation()">
    <div class="filters-header">
      <h3>Filtres intelligents</h3>
      <button class="close-btn" (click)="closeFilters()">
        <i antIcon type="close" theme="outline"></i>
      </button>
    </div>
    <div class="filters-content">
      <div class="filter-section">
        <h4>Filtres de base</h4>
        <div class="filter-row">
          <div class="filter-group">
            <label>Statut</label>
            <select [(ngModel)]="smartFilters.status">
              <option value="">Tous les statuts</option>
              <option value="PENDING">En attente</option>
              <option value="APPROVED">Approuvées</option>
              <option value="REJECTED">Rejetées</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Période</label>
            <select [(ngModel)]="smartFilters.period">
              <option value="">Toute période</option>
              <option value="7">7 derniers jours</option>
              <option value="30">30 derniers jours</option>
              <option value="90">3 derniers mois</option>
              <option value="365">Cette année</option>
            </select>
          </div>
        </div>
        <div class="filter-row">
          <div class="filter-group">
            <label>Montant minimum (TND)</label>
            <input type="number" [(ngModel)]="smartFilters.minAmount" placeholder="0">
          </div>
          <div class="filter-group">
            <label>Montant maximum (TND)</label>
            <input type="number" [(ngModel)]="smartFilters.maxAmount" placeholder="∞">
          </div>
        </div>
      </div>
      
      <div class="filter-section">
        <h4>Filtres avancés</h4>
        <div class="filter-row">
          <div class="filter-group">
            <label>Progression de remboursement</label>
            <select [(ngModel)]="smartFilters.progress">
              <option value="">Toutes</option>
              <option value="0-25">0-25%</option>
              <option value="25-50">25-50%</option>
              <option value="50-75">50-75%</option>
              <option value="75-100">75-100%</option>
              <option value="100">100% (Terminé)</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Motif de demande</label>
            <select [(ngModel)]="smartFilters.reason">
              <option value="">Tous les motifs</option>
              <option value="Urgent">Urgent</option>
              <option value="Personnel">Personnel</option>
              <option value="Professionnel">Professionnel</option>
            </select>
          </div>
        </div>
      </div>

      <div class="filter-section">
        <h4>Suggestions intelligentes</h4>
        <div class="smart-suggestions">
          <button class="suggestion-btn" (click)="applySuggestion('recent')">
            <i antIcon type="clock" theme="outline"></i>
            Demandes récentes
          </button>
          <button class="suggestion-btn" (click)="applySuggestion('high-amount')">
            <i antIcon type="rise" theme="outline"></i>
            Montants élevés
          </button>
          <button class="suggestion-btn" (click)="applySuggestion('pending')">
            <i antIcon type="clock" theme="outline"></i>
            En attente
          </button>
          <button class="suggestion-btn" (click)="applySuggestion('completed')">
            <i antIcon type="check-circle" theme="outline"></i>
            Terminées
          </button>
        </div>
      </div>

      <div class="filters-actions">
        <button class="reset-btn" (click)="resetFilters()">
          <i antIcon type="reload" theme="outline"></i>
          Réinitialiser
        </button>
        <button class="apply-btn" (click)="applySmartFilters()">
          <i antIcon type="check" theme="outline"></i>
          Appliquer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Message de succès pour les filtres -->
<div class="success-message" *ngIf="showSuccessMessage" [ngClass]="{'error-message': isErrorMessage}">
  <div class="success-content" [ngClass]="{'error-content': isErrorMessage}">
    <i antIcon [type]="isErrorMessage ? 'close-circle' : 'check-circle'" theme="outline"></i>
    <span>{{ successMessage }}</span>
  </div>
</div>


  