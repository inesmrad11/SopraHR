<app-breadcrumb [breadcrumbItems]="breadcrumbs"></app-breadcrumb>

<!-- Dashboard moderne avec design harmonisé -->
<div class="light-dashboard">
  <!-- Header avec style identique à employee-home -->
  <div class="welcome-banner">
    <div class="welcome-banner-overlay"></div>
    <div class="welcome-banner-content">
      <div class="welcome-banner-text">
        <div class="welcome-greeting">Gestion des demandes d'avance</div>
        <div class="welcome-description">Validez et gérez les demandes d'avance de salaire des employés.</div>
      </div>
      <div class="welcome-banner-actions">
        <div class="search-container">
          <button class="action-btn search-btn" (click)="toggleSearch()" *ngIf="!showSearch">
            <i antIcon type="search" theme="outline"></i>
          </button>
          <div class="inline-search" *ngIf="showSearch">
            <div class="search-input-wrapper">
              <i antIcon type="search" theme="outline"></i>
              <input 
                type="text" 
                placeholder="Rechercher un employé..." 
                [(ngModel)]="filterName"
                (input)="applyFilters()"
                class="inline-search-input"
                autofocus
              >
              <button class="close-inline-search" (click)="closeSearch()">
                <i antIcon type="close" theme="outline"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



  <!-- Modal des notifications -->
  <div class="notification-overlay" *ngIf="showNotifications" (click)="closeNotifications()">
    <div class="notification-modal" (click)="$event.stopPropagation()">
      <div class="notification-header">
        <h3>Notifications</h3>
        <button class="close-btn" (click)="closeNotifications()">
          <i antIcon type="close" theme="outline"></i>
        </button>
      </div>
      <div class="notification-content">
        <div class="notification-item" *ngFor="let notification of notifications">
          <div class="notification-icon" [ngClass]="notification.type">
            <i antIcon [type]="getNotificationIcon(notification.type)" theme="outline"></i>
          </div>
          <div class="notification-body">
            <div class="notification-title">{{ notification.title }}</div>
            <div class="notification-message">{{ notification.message }}</div>
            <div class="notification-time">{{ notification.createdAt | date:'short' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- États de chargement et erreur -->
  <div *ngIf="loading" class="loading-state">
    <div class="loading-spinner"></div>
    <div class="loading-text">Chargement des demandes...</div>
  </div>
  
  <div *ngIf="error" class="error-state">
    <div class="error-icon">⚠️</div>
    <div class="error-message">{{ error }}</div>
    <button class="retry-btn" (click)="fetchRequests()">Réessayer</button>
  </div>

  <div *ngIf="successMessage" class="success-message">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>

  <!-- Filtres avancés -->
  <div class="filters-section" *ngIf="showFilters">
    <div class="filters-container">
      <div class="filters-header">
        <h3>Filtres avancés</h3>
        <button class="close-filters-btn" (click)="toggleFilters()">
          <i antIcon type="close" theme="outline"></i>
        </button>
      </div>
      <div class="filters-content">
        <div class="filter-row">
          <div class="filter-group">
            <label>Date de début</label>
            <input type="date" [(ngModel)]="filterFrom" (change)="applyFilters()">
          </div>
          <div class="filter-group">
            <label>Date de fin</label>
            <input type="date" [(ngModel)]="filterTo" (change)="applyFilters()">
          </div>
        </div>
        <div class="filters-actions">
          <button class="btn btn-secondary" (click)="clearFilters()">Effacer</button>
          <button class="btn btn-primary" (click)="applyFilters()">Appliquer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tableau des demandes -->
  <div class="requests-section">
    <div class="requests-header">
      <h2 class="requests-title">Demandes d'avance ({{ filteredRequests.length }})</h2>
      <button class="filters-btn" (click)="toggleFilters()">
        <i antIcon type="tool" theme="outline"></i>
        Filtres
      </button>
    </div>
    
    <div class="requests-table">
      <table class="table">
        <thead>
          <tr>
            <th class="employee-header">Employé</th>
            <th class="amount-header">Montant</th>
            <th class="date-header">Date de demande</th>
            <th class="actions-header">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let req of paginatedRequests" class="table-row">
            <td class="employee-cell">
              <div class="employee-info">
                <div class="employee-avatar">
                  <img 
                    *ngIf="req.employeeProfilePicture" 
                    [src]="req.employeeProfilePicture" 
                    [alt]="req.employeeFullName"
                    class="employee-photo"
                    (error)="onImageError($event)"
                    (load)="onImageLoad($event)"
                  >
                  <div 
                    *ngIf="!req.employeeProfilePicture || !hasProfilePicture(req)" 
                    class="employee-initials"
                  >
                    {{ getEmployeeInitials(req.employeeFullName) }}
                  </div>
                </div>
                <span class="employee-name">{{ req.employeeFullName }}</span>
              </div>
            </td>
            <td class="amount-cell">{{ req.requestedAmount | number:'1.2-2' }} TND</td>
            <td class="date-cell">{{ req.requestDate | date:'shortDate' }}</td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button class="action-btn view-btn" title="Voir détails" (click)="openDetails(req)">
                  <i antIcon type="eye" theme="outline"></i>
                  <span class="btn-label">Voir</span>
                </button>
                <button 
                  class="action-btn approve-btn" 
                  title="Valider la demande" 
                  (click)="approveRequest(req)"
                  *ngIf="req.status === 'PENDING'">
                  <i antIcon type="check" theme="outline"></i>
                  <span class="btn-label">Valider</span>
                </button>
                <button 
                  class="action-btn reject-btn" 
                  title="Rejeter la demande" 
                  (click)="rejectRequest(req)"
                  *ngIf="req.status === 'PENDING'">
                  <i antIcon type="close" theme="outline"></i>
                  <span class="btn-label">Rejeter</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination -->
      <div *ngIf="filteredRequests.length > 0" class="pagination-section">
        <div class="pagination-left">
          <span class="pagination-info">{{ paginationInfo }}</span>
          <div class="items-per-page">
            <label>Afficher:</label>
            <select 
              [(ngModel)]="itemsPerPage" 
              (change)="onItemsPerPageChange()"
              class="items-per-page-select">
              <option *ngFor="let option of itemsPerPageOptions" [value]="option">
                {{ option }} éléments
              </option>
            </select>
          </div>
        </div>
        <div class="pagination-controls">
          <button 
            class="pagination-btn"
            (click)="previousPage()"
            [disabled]="currentPage === 1">
            <i antIcon type="left" theme="outline"></i>
          </button>
          <span class="page-info">{{ currentPage }} / {{ totalPages }}</span>
          <button 
            class="pagination-btn"
            (click)="nextPage()"
            [disabled]="currentPage === totalPages">
            <i antIcon type="right" theme="outline"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<app-validation-modal 
  [visible]="modalVisible"
  (confirm)="onModalConfirm($event)"
  (cancel)="onModalCancel()">
</app-validation-modal>

<!-- Modal détails simplifié -->
<div class="modal-backdrop" *ngIf="selectedRequest" (click)="closeDetailsModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">Détail de la demande</h3>
      <button class="modal-close" (click)="closeDetailsModal()" aria-label="Fermer">
        <i antIcon type="close" theme="outline"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="modal-details">
        <div class="detail-row">
          <span class="detail-label">Salarié</span>
          <span class="detail-value">{{ selectedRequest.employeeFullName }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Date de demande</span>
          <span class="detail-value">{{ selectedRequest.requestDate | date:'shortDate' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Montant demandé</span>
          <span class="detail-value">{{ selectedRequest.requestedAmount | number:'1.2-2' }} TND</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Durée de remboursement</span>
          <span class="detail-value">{{ selectedRequest.repaymentMonths || '?' }} mois</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Statut</span>
          <span class="status-badge" [ngClass]="'status-' + selectedRequest.status.toLowerCase()">
            {{ getStatusLabel(selectedRequest.status) }}
          </span>
        </div>
        <div class="detail-row full-width">
          <span class="detail-label">Motif</span>
          <span class="detail-value">{{ selectedRequest.reason || 'Non spécifié' }}</span>
        </div>
        
        <div class="divider"></div>
        
        <div class="financial-info">
          <div class="financial-item">
            <span class="financial-label">Salaire net</span>
            <span class="financial-value">{{ selectedRequest.employeeSalaryNet | number:'1.2-2' }} TND</span>
          </div>
          <div class="financial-item">
            <span class="financial-label">Plafond disponible</span>
            <span class="financial-value">{{ selectedRequest.plafondDisponible | number:'1.2-2' }} TND</span>
          </div>
          <div class="financial-item">
            <span class="financial-label">Avances non remboursées</span>
            <span class="financial-value">{{ selectedRequest.totalAvancesNonRemboursees | number:'1.2-2' }} TND</span>
          </div>
        </div>
      </div>
      
      <div class="comment-section" *ngIf="selectedRequest.status === 'PENDING'">
        <label class="comment-label">Commentaire (optionnel)</label>
        <textarea [(ngModel)]="modalComment" placeholder="Ajouter un commentaire..." rows="3" class="comment-input"></textarea>
      </div>
      
      <div *ngIf="modalError" class="error-message">{{ modalError }}</div>
    </div>
    
    <div class="modal-footer" *ngIf="selectedRequest.status === 'PENDING'">
      <button class="btn btn-success" (click)="approveSelectedRequest()" [disabled]="modalLoading">
        <span *ngIf="modalLoading" class="spinner"></span>
        Valider
      </button>
      <button class="btn btn-danger" (click)="rejectSelectedRequest()" [disabled]="modalLoading">
        <span *ngIf="modalLoading" class="spinner"></span>
        Rejeter
      </button>
    </div>
  </div>
</div>